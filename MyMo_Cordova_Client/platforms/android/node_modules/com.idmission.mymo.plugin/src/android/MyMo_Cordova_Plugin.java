package com.idmission.mymo.plugin;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.util.Base64;
import android.view.View;
import android.view.inputmethod.InputMethodManager;

import com.idmission.mymo.Client.MainActivity;
import com.idmission.mymo.latin.utils.MyMoSettings;

import org.apache.cordova.CordovaPlugin;
import org.apache.cordova.CallbackContext;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

/**
 * This class echoes a string called from JavaScript.
 */
public class MyMo_Cordova_Plugin extends CordovaPlugin {

    @Override
    public boolean execute(String action, JSONArray args, CallbackContext callbackContext) throws JSONException {
        String message = args.optString(0);
        switch (action) {
            case "coolMethod" :
                this.coolMethod(message, callbackContext);
                return true;
            case "enableMyMoInSettings" :
                this.enableMyMoInSettings(message, callbackContext);
                return true;
            case "selectKeyboardOptions" :
                this.selectKeyboardOptions(message, callbackContext);
                return true;
            case "hideKeyboard" :
                this.hideKeyboard(message, callbackContext);
                return true;
            case "showKeyboard" :
                this.showKeyboard(message, callbackContext);
                return true;
            case "enableMyMoToAllowSendMoney" :
                this.enableMyMoToAllowSendMoney(message, callbackContext);
                return true;
            case "disableMyMoToRestrictSendMoney" :
                this.disableMyMoToRestrictSendMoney(message, callbackContext);
                return true;
            default :
                return false;
        }
        // return false;
    }

    private void coolMethod(String message, CallbackContext callbackContext) {
        if (message != null && message.length() > 0) {
            callbackContext.success(message);
        } else {
            callbackContext.error("Expected one non-empty string argument.");
        }
    }

    private void enableMyMoInSettings(String message, CallbackContext callbackContext) {
        Intent enableIntent = new Intent(android.provider.Settings.ACTION_INPUT_METHOD_SETTINGS);
        enableIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        cordova.getActivity().startActivity(enableIntent);
    }

    private void selectKeyboardOptions(String message, CallbackContext callbackContext) {
        InputMethodManager imm = (InputMethodManager)  cordova.getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);
        imm.showInputMethodPicker();
    }

    private void disableMyMoToRestrictSendMoney(String message, CallbackContext callbackContext) {
        final MyMoSettings myMoSettings = MyMoSettings.getInstance(cordova.getActivity().getApplicationContext());
        myMoSettings.disableMyMo();
        hideKeyboard( message,callbackContext);
        showKeyboard(message,callbackContext);
        callbackContext.success(message);
    }

    private void enableMyMoToAllowSendMoney(String message, CallbackContext callbackContext){
        try{
            JSONObject requestObj = new JSONObject(message);
            String phoneNumber = requestObj.optString("phNo");
            String senderName = requestObj.optString("senderName");
            String customerCode = requestObj.optString("custCode");
            String countryCode = requestObj.optString("countryCode");
            String currencyCode = requestObj.optString("currencyCode");
            String integLoginId = requestObj.optString("loginId");
            String integPassword = requestObj.optString("password");
            String integMerchantId = requestObj.optString("merchantId");
            String language = requestObj.optString("locale");
            String postURL = requestObj.optString("postURL");
            String branchCode = requestObj.optString("branchCode");
            String minAmount = requestObj.optString("minAmt");
            String maxAmount = requestObj.optString("maxAmt");
            String accountNumber = requestObj.optString("bnkAcc");
            String banksdropdown = requestObj.optString("banksdropdown");

            String txnSecurityOtp = requestObj.optString("txnSecurity");
            String txnSecurityReceiverPh = requestObj.optString("recPhoneSecurity");
            String txnSecurityPin = requestObj.optString("txnSecurityPin");
            String PinValidateAtIDM = requestObj.optString("PinValidateAtIDM");
            String customerSecurityPin = requestObj.optString("customerSecurityPin");

            String textColor = requestObj.optString("textColor");
            //String textColorSelected = requestObj.optString("textColorSelected");
           // String buttonColor = requestObj.optString("buttonColor");
            String editBoxBackClr = requestObj.optString("editBoxBackClr");
            String histHeaderBackClr = requestObj.optString("histHeaderBackClr");
            String txnSuccessTxtClr = requestObj.optString("txnSuccessTxtClr");
            String alertTxtClr = requestObj.optString("alertTxtClr");

            String confirmTxnYesBtnClr = requestObj.optString("confirmTxnYesBtnClr");
            String confirmTxnNoBtnClr = requestObj.optString("confirmTxnNoBtnClr");

            String closeBtnClr = requestObj.optString("closeBtnClr");
            String confirmCancelTxnBtnClr = requestObj.optString("confirmCancelTxnBtnClr");

            String confirmCancelYesBtnClr = requestObj.optString("confirmCancelYesBtnClr");
            String confirmCancelNoBtnClr = requestObj.optString("confirmCancelNoBtnClr");

           // String sendMoney = requestObj.optString("sendMoney");
           // String atm = requestObj.optString("atm");
           // String history = requestObj.optString("history");

            String mymoIconImg = requestObj.optString("mymoIconImg");
            String sendMoneyIcon = requestObj.optString("sendMoneyIcon");
            String atmIcon = requestObj.optString("atmIcon");
            String histIcon = requestObj.optString("histIcon");
            String payIcon = requestObj.optString("payIcon");
            String arrowIcon = requestObj.optString("arrowIcon");
            String txnSuccessIcon = requestObj.optString("txnSuccessIcon");
            String alertIcon = requestObj.optString("alertIcon");
            String contactIcon = requestObj.optString("contactIcon");
            String processingIcon = requestObj.optString("processingIcon");

            String phoneLength = requestObj.optString("phoneLength");
            String currencySymbol = requestObj.optString("currencySymbol");

            final MyMoSettings myMoSettings = MyMoSettings.getInstance(cordova.getActivity().getApplicationContext());
            myMoSettings.enableMyMo();
            myMoSettings.setPhoneNumber(phoneNumber);
            if(!"".equals(senderName)){
                myMoSettings.setSenderName(senderName);
            }
            myMoSettings.setCustomerCode(customerCode);
            myMoSettings.setCountryCode(countryCode);
            myMoSettings.setCurrencyCode(currencyCode);
            myMoSettings.setIntegLoginId(integLoginId);
            myMoSettings.setIntegPassword(integPassword);
            myMoSettings.setIntegMerchantId(integMerchantId);
            myMoSettings.setMinimumAmount(minAmount);
            myMoSettings.setMaximumAmount(maxAmount);
            myMoSettings.setLanguage(language);
            myMoSettings.setPostURL(postURL);
            if(!"".equals(branchCode)){
                myMoSettings.setBranchCode(branchCode);
            }
            if(!"".equals(branchCode)){
                myMoSettings.setBankAccountNo(accountNumber);
            }
            myMoSettings.setBankAccountType(banksdropdown);
            myMoSettings.setTxnSecurityOTP(txnSecurityOtp);
            myMoSettings.setTxnSecurityReceiverPhoneNo(txnSecurityReceiverPh);
            myMoSettings.setTxnSecurityPIN(txnSecurityPin);
            myMoSettings.setPinValidateAtIDM(PinValidateAtIDM);
            myMoSettings.setCustomerSecurityPIN(customerSecurityPin.trim());
            myMoSettings.setPhoneNumberLength(phoneLength.trim());
            myMoSettings.setCurrencySymbol(currencySymbol.trim());

            // UI ICONS changes
            Bitmap mymoIconbitmap = convertBase64StringToBitMap(mymoIconImg);
            myMoSettings.setMyMoBitmapDrawable(mymoIconbitmap);

            Bitmap walletIconbitmap = convertBase64StringToBitMap(sendMoneyIcon);
            myMoSettings.setWalletBitmapDrawable(walletIconbitmap);

            Bitmap atmIconbitmap = convertBase64StringToBitMap(atmIcon);
            myMoSettings.setAtmBitmapDrawable(atmIconbitmap);

            Bitmap historyIconbitmap = convertBase64StringToBitMap(histIcon);
            myMoSettings.setHistoryBitmapDrawable(historyIconbitmap);

            Bitmap payIconBitMap = convertBase64StringToBitMap(payIcon);
            myMoSettings.setPayBitmapDrawable(payIconBitMap);

            Bitmap arrowIconBitMap = convertBase64StringToBitMap(arrowIcon);
            myMoSettings.setDownArrowBitmapDrawable(arrowIconBitMap);

            Bitmap txnSuccessIconBitMap = convertBase64StringToBitMap(txnSuccessIcon);
            myMoSettings.setTxnSuccessIconBitmapDrawable(txnSuccessIconBitMap);

            Bitmap alertIconBitMap = convertBase64StringToBitMap(alertIcon);
            myMoSettings.setAlertIconBitmapDrawable(alertIconBitMap);

            Bitmap contactIconBitMap = convertBase64StringToBitMap(contactIcon);
            myMoSettings.setContactIconBitmapDrawable(contactIconBitMap);

            Bitmap processingIconBitMap = convertBase64StringToBitMap(processingIcon);
            myMoSettings.setProcessingIconBitmapDrawable(processingIconBitMap);

            // UI Color changes
             myMoSettings.setTextColor(textColor.trim());
           //  myMoSettings.setTextColorSelected(textColorSelected.trim());
          //   myMoSettings.setPayBtnBackgroundColor(buttonColor.trim());
             myMoSettings.setEditboxBackgroundColor(editBoxBackClr.trim());
             myMoSettings.setHistoryListHeaderColor(histHeaderBackClr);
             myMoSettings.setSuccessMsgTextColor(txnSuccessTxtClr);
             myMoSettings.setAlertMsgTextColor(alertTxtClr);

            myMoSettings.setConfirmTxnYesButtonColor(confirmTxnYesBtnClr);
            myMoSettings.setConfirmTxnNoButtonColor(confirmTxnNoBtnClr);

            myMoSettings.setCancelTxnCloseButtonColor(closeBtnClr);
            myMoSettings.setCancelTxnConfirmButtonColor(confirmCancelTxnBtnClr);

            myMoSettings.setConfirmCancelTxnYesButtonColor(confirmCancelYesBtnClr);
            myMoSettings.setConfirmCancelTxnNoButtonColor(confirmCancelNoBtnClr);



            // UI Strings/Label changes
            /* myMoSettings.setSendMoneyLabel(sendMoney.trim());
             myMoSettings.setSendToAtmLabel(atm.trim());
             myMoSettings.setHistoryLabel(history.trim());*/

           /* hideKeyboard( message,callbackContext);
            showKeyboard(message,callbackContext);*/
            callbackContext.success(message);
        }catch (Exception e){

        }
    }


    private Bitmap convertBase64StringToBitMap(String base64String){

        String encodedImage = base64String;
        final String pureBase64Encoded = encodedImage.substring(encodedImage.indexOf(",")  + 1);
        if(null!=pureBase64Encoded) {
            byte[] decodedString = Base64.decode(pureBase64Encoded, Base64.DEFAULT);
            Bitmap decodedByte = BitmapFactory.decodeByteArray(decodedString, 0, decodedString.length);
            return decodedByte;
        }
        return null;
    }

    private  void hideKeyboard(String message, CallbackContext callbackContext) {
        try {
            InputMethodManager imm = (InputMethodManager) cordova.getActivity().getSystemService( cordova.getActivity().INPUT_METHOD_SERVICE);
            View view = cordova.getActivity().getCurrentFocus();
            assert view != null;
            imm.hideSoftInputFromWindow(view.getWindowToken(), 0);
        }catch (Exception e){
            e.printStackTrace();
        }
    }

    private  void showKeyboard(String message, CallbackContext callbackContext) {
        try {
            View view = cordova.getActivity().getCurrentFocus();
            InputMethodManager methodManager = (InputMethodManager) cordova.getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);
            assert methodManager != null && view != null;
            methodManager.showSoftInput(view, InputMethodManager.SHOW_IMPLICIT);
        }catch (Exception e){
            e.printStackTrace();
        }
    }

}
